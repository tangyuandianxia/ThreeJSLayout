<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            /*background-color: #969696;*/
            /*background-color: #fff;*/
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display:block;
        }
        #info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }
    </style>
</head>
<body>
<!--<script type="text/javascript" src="../learning-threejs-master/libs/three.js"></script>
<script type="text/javascript" src="../learning-threejs-master/libs/OBJLoader.js"></script>
<script type="text/javascript" src="../learning-threejs-master/libs/MTLLoader.js"></script>
<script type="text/javascript" src="../learning-threejs-master/libs/OBJMTLLoader.js"></script>-->


<script src="../three.js-master/build/three.js"></script>
<script src="../three.js-master/examples/js/loaders/OBJLoader.js"></script>
<script src="../three.js-master/examples/js/loaders/MTLLoader.js"></script>

<script src="../three.js-master/examples/js/controls/TrackballControls.js"></script>
<script src="../three.js-master/examples/js/controls/OrbitControls.js"></script>


<script src="../three.js-master/examples/js/shaders/CopyShader.js"></script>
<script src="../three.js-master/examples/js/shaders/FXAAShader.js"></script>
<script src="../three.js-master/examples/js/postprocessing/EffectComposer.js"></script>
<script src="../three.js-master/examples/js/postprocessing/RenderPass.js"></script>

<script src="../three.js-master/examples/js/postprocessing/ShaderPass.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/shaders/CopyShader.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/shaders/ColorifyShader.js"></script>

<script src="../three.js-master/examples/js/postprocessing/OutlinePass.js"></script>

<script type="text/javascript" src="../three.js-master/examples/js/postprocessing/BloomPass.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/shaders/ConvolutionShader.js"></script>

<script type="text/javascript" src="../three.js-master/examples/js/postprocessing/MaskPass.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/postprocessing/FilmPass.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/shaders/FilmShader.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/shaders/SepiaShader.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/postprocessing/SavePass.js"></script>
<script type="text/javascript" src="../three.js-master/examples/js/postprocessing/TexturePass.js"></script>
<div id="glFullscreen">
    <!--<canvas id="mainCanvas" width="1920" height="948"></canvas>-->
    <!--<canvas id="mainCanvas" width="1800" height="900"></canvas>-->
    <canvas id="example" width="1800" height="900"></canvas>
</div>

<script type="text/javascript">
    var container;
    var camera, scene, renderer;

    var  meshObj = null;

    //测试
    var composer, effectFXAA, outlinePass;
    var obj3d = new THREE.Object3D();

    var group = new THREE.Group();

    var raycaster = new THREE.Raycaster();

    var mouse = new THREE.Vector2();
    var selectedObjects = [];

    var OBJFlag = true;

    var clock;
    var controls;
    var raycaster = null;
    var mouse = new THREE.Vector2(), INTERSECTED;


    init();
//    animate();
    function init() {
        renderer = new THREE.WebGLRenderer({//渲染器
            canvas: document.getElementById('example')//画布
            ,
            alpha: true,//设置场景透明
            antialias:true,//抗锯齿
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        scene = new THREE.Scene();//创建场景

        //            网格宽度、等分数、中心线颜色，网格线颜色
        var helper = new THREE.GridHelper(1200, 60, 0xFF4444, 0x404040);
        scene.add(helper);

        //在场景中添加坐标轴
        var axes = new THREE.AxesHelper(2000);
        scene.add(axes);

        camera = new THREE.PerspectiveCamera( 30, 1, 0.1, 10000 );//透视摄影机
        camera.position.set(1300.0, 600.0, 1200.0);//相机位置

//            camera.position.set(-0.0, 0.0, 0.0);//相机位置
//            camera.lookAt(new THREE.Vector3(0, 2, 0));//lookAt()设置相机所看的位置
//            camera.lookAt(new THREE.Vector3(0, 0, 0));//lookAt()设置相机所看的位置
            camera.lookAt(new THREE.Vector3(0, 0, 0));//lookAt()设置相机所看的位置
//        camera.lookAt(scene.position);//lookAt()设置相机所看的位置

        scene.add(camera);//把相机添加到场景中

        //环境光
//        var ambientLight = new THREE.AmbientLight( 0x404040 );
        var ambientLight = new THREE.AmbientLight( 'white' );
        //方向光
        var directionalLight1 = new THREE.DirectionalLight( 0xC0C090 );
        var directionalLight2 = new THREE.DirectionalLight( 0xC0C090 );
//            var ambientLight = new THREE.AmbientLight( 'white' );
//            var directionalLight1 = new THREE.DirectionalLight( 'white' );
//            var directionalLight2 = new THREE.DirectionalLight( 'white' );
        directionalLight1.position.set( -100, -50, 100 );
        directionalLight2.position.set( 100, 50, -100 );
        scene.add(directionalLight1);
        scene.add(directionalLight2);
        scene.add(ambientLight);

        //TODO 多场景测试
        var sceneEarth = new THREE.Scene();
        var sceneMars = new THREE.Scene();

        var ambi = new THREE.AmbientLight(0x181818);
        var ambi2 = new THREE.AmbientLight(0x181818);
        sceneEarth.add(ambi);
        sceneMars.add(ambi2);

        var spotLight = new THREE.DirectionalLight('white');
        spotLight.position.set(550, 100, 550);
        spotLight.intensity = 0.6;

        var spotLight2 = new THREE.DirectionalLight(0xffffff);
        spotLight.position.set(0, 0, 100);
        spotLight.intensity = 0.6;

        sceneEarth.add(spotLight);
        sceneMars.add(spotLight2);

        sceneEarth.add(directionalLight1);
        sceneEarth.add(directionalLight2);
        sceneMars.add(directionalLight1);
        sceneMars.add(directionalLight2);


////监听鼠标、键盘事件，旋转图形
        controls = new THREE.OrbitControls(camera);
//        controls = new THREE.TrackballControls( camera, renderer.domElement );


        controls.autoRotate = false;
        clock = new THREE.Clock();

        var material = new THREE.MeshPhongMaterial({
//            color: 'green',
            wireframe:false,
            map: new THREE.TextureLoader().load('images/xian1.jpg'),
        })
        box = new THREE.Mesh(new THREE.BoxBufferGeometry(100,100,100,10,10,10),material);
        scene.add(box);

        /***
         * 加载obj
         * @type {THREE.OBJLoader}
         */
        var  texture = new THREE.TextureLoader().load('images/xian1.jpg');
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;

        var mtlLoader = new THREE.MTLLoader();
        mtlLoader.setPath('obj/skjc/');
        mtlLoader.load('shukongjichuang.mtl', function (materials) {
            materials.preload();//预加载

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('obj/skjc/');
//                objLoader.setPath('obj/');
//                objLoader.load('OBJ-TEST.obj', function(object) {
//                objLoader.load('car.obj', function(object) {
            objLoader.load("shukongjichuang.obj", function (object) {
                        object.rotation.y = 0;
                        object.position.x = 0;
                        object.position.y = 100;
                        object.position.z = 0;
//            object.scale.set(0.1, 0.1, 0.1);//缩放

                        object.name = 'shukongjichuang';
//                    object.scale.multiplyScalar(1);
                        meshObj = object;
                        obj3d.add(object);
                        group.add(object);
                        //放入场景
//                        scene.add(object);
//                        sceneMars.add(object);

                    },
                    onProgress, onError);
        });

        mtlLoader.load('shukongjichuang2.mtl', function (materials) {
            materials.preload();//预加载

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('obj/skjc/');
            objLoader.load("shukongjichuang2.obj", function (object) {
                        object.rotation.y = 0;
                        var x=300,y=100,z=200;
                        object.position.x = x;
                        object.position.y = y;
                        object.position.z = z;
                        var directionalLight = new THREE.DirectionalLight( 0xC0C090 );
                        directionalLight.position.set( x, y, z );
                        scene.add(directionalLight);
//            object.scale.set(0.1, 0.1, 0.1);//缩放

                        object.name = 'shukongjichuang2';
//                    object.scale.multiplyScalar(1);
                        /*object.traverse( function ( child ) {
                            if ( child instanceof THREE.Mesh ) {
                                //给name为A开头的模型贴图
//                            if(child.name.indexOf("A")==0){
//                                child.material.map = texture;
                                //每个储位单独赋予一个基础材质
                            child.material = new THREE.MeshPhongMaterial({color:  0xff0000});//(红色)
//                            child.material.map = texture;
//                            }
                            }
                        } );*/
                        /*object.children[0].material = new THREE.MeshLambertMaterial({
//                            color:  0xff0000,
                            side: THREE.FrontSide,
//                            opacity:0.6,
//                            transparent:true,
//                            ambient:'red',//环境色
//                            emissive:'green',
//                            shiniess:5,
//                            blending:THREE.NormalBlending,
                            needsUpdate:true,
                        });//(红色)*/

                        meshObj = object;
                        var boxhelper=new THREE.BoxHelper(object);
//                        boxhelper.material.color.set("red");

                        scene.add(boxhelper);
                        //放入场景
                        scene.add(object);
//                        sceneEarth.add(object);

                    },
                    onProgress, onError);
        });

        mtlLoader.load('kaijuanji.mtl', function (materials) {
            materials.preload();//预加载

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('obj/skjc/');
            objLoader.load("kaijuanji.obj", function (object) {
                        object.rotation.y = 0;
                        object.position.x = -300;
                        object.position.y = 110;
                        object.position.z = 200;
//            object.scale.set(0.1, 0.1, 0.1);//缩放
                        object.name = 'kaijuanji';
                        meshObj = object;

                        var boxhelper=new THREE.BoxHelper(object);
                        scene.add(boxhelper);

                        //放入场景
                        scene.add(object);

                    },
                    onProgress, onError);
        });
        //TODO  后期处理测试中
        composer = new THREE.EffectComposer( renderer );
        composer.renderTarget1.stencilBuffer = true;
        composer.renderTarget2.stencilBuffer = true;

        var renderPass = new THREE.RenderPass( scene, camera );
        var renderPass1 = new THREE.RenderPass(sceneEarth, camera);
        renderPass1.clear = false;
        var renderPass2 = new THREE.RenderPass(sceneMars, camera);
        renderPass2.clear = false;
//        renderPass.clear = false;
        /*outlinePass = new THREE.OutlinePass( new THREE.Vector2( window.innerWidth, window.innerHeight ), scene, camera );
        composer.addPass( outlinePass );*/

        var effectCopy = new THREE.ShaderPass(THREE.CopyShader);
        effectCopy.renderToScreen = true;

        var clearMask = new THREE.ClearMaskPass();
        var earthMask = new THREE.MaskPass(scene, camera);
        // mars mask
        var marsMask = new THREE.MaskPass(sceneMars, camera);
        var effectSepia = new THREE.ShaderPass(THREE.SepiaShader);
        effectSepia.uniforms['amount'].value = 0.8;

        var effectColorify = new THREE.ShaderPass(THREE.ColorifyShader);
//        effectColorify.uniforms['color'].value.setRGB(0.5, 0.5, 1);
        effectColorify.uniforms['color'].value.setRGB(255, 99, 71);


        composer.addPass(renderPass);
        composer.addPass(renderPass1);
        composer.addPass(renderPass2);

        /*composer.addPass(earthMask);
        composer.addPass(effectSepia);
        composer.addPass(clearMask);*/

        composer.addPass(marsMask);
        composer.addPass(effectColorify);
        composer.addPass(clearMask);

        composer.addPass(effectCopy);

//        outlinePass.selectedObjects = obj3d;
//        window.addEventListener( 'resize', onWindowResize, false );

//        window.addEventListener( 'mousemove', onTouchMove );
//        window.addEventListener( 'touchmove', onTouchMove );

        function onTouchMove( event ) {

            var x, y;

            if ( event.changedTouches ) {

                x = event.changedTouches[ 0 ].pageX;
                y = event.changedTouches[ 0 ].pageY;

            } else {

                x = event.clientX;
                y = event.clientY;

            }

            mouse.x = ( x / window.innerWidth ) * 2 - 1;
            mouse.y = - ( y / window.innerHeight ) * 2 + 1;

            checkIntersection();

        }


        function checkIntersection() {

            raycaster.setFromCamera( mouse, camera );

            var intersects = raycaster.intersectObjects( [ scene ], true );

            if ( intersects.length > 0 ) {

                var selectedObject = intersects[ 0 ].object;
                addSelectedObject( selectedObject );
                outlinePass.selectedObjects = selectedObjects;

            } else {

                // outlinePass.selectedObjects = [];

            }

        }
        box.material = new THREE.MeshPhongMaterial({
//            color: 0xff0000 ,
            map: new THREE.TextureLoader().load('images/caodi.jpg'),
        });//(红色)


        /*obj3d.material = new THREE.MeshPhongMaterial({
            color: 'red' ,
            map: new THREE.TextureLoader().load('images/caodi.jpg'),
        });//(红色)*/

        //捕获模型
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
//            var mouse = new THREE.Vector2(), INTERSECTED;
//            document.addEventListener( 'mousemove', onDocumentMouseMove, false );
//            document.addEventListener( 'mousemove', onMouseMove, false );
//            id = setInterval(draw, 20);//每隔20s重绘一次

        //TODO 测试
        window.addEventListener( 'click', onMouseClick, false );
// 通过鼠标点的位置和当前相机的矩阵计算出raycaster
        raycaster.setFromCamera( mouse, camera );

//        box.material.color.set( 'red' );

        render();

    }
    var onProgress = function(xhr) {
        if (xhr.lengthComputable) {
            var percentComplete = xhr.loaded / xhr.total * 100;
            var percent = document.getElementById("percent");
//                    percent.innerText = Math.round(percentComplete, 2) + '% 已经加载';
        }

       console.log("onProgress 方法执行完毕");
    };
    var onError = function(xhr) {};
    function onMouseClick( event ) {

        //通过鼠标点击的位置计算出raycaster所需要的点的位置，以屏幕中心为原点，值的范围为-1到1.

        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;


// 获取raycaster直线和所有模型相交的数组集合
        var intersects = raycaster.intersectObjects( scene.children,true );
        /*for ( var i = 0; i < intersects.length; i++ ) {
            //                intersects[ i ].object.material.color.set( 0xff0000 );
            intersects[ i ].object.material.color.set( 'red' );
        }*/
    }

    function animate() {
        requestAnimationFrame( animate );

        render();

        /*if(OBJFlag){
            /!*meshObj.traverse( function ( child ) {
                if ( child instanceof THREE.Mesh ) {
                    //给name为A开头的模型贴图
//                            if(child.name.indexOf("A")==0){
//                                child.material.map = texture;
                    //每个储位单独赋予一个基础材质
                    child.material = new THREE.MeshPhongMaterial({
//                    color: 0xff0000 ,
                        map: new THREE.TextureLoader().load('images/envmap1.jpg'),
                    });//(红色)
//                            child.material.map = texture;
//                            }
                    OBJFlag = false;
                }
            } );*!/
            meshObj.children[0].material = new THREE.MeshPhongMaterial({
                    color: 0xff0000 ,
//                map: new THREE.TextureLoader().load('images/envmap1.jpg'),
            });

        }*/

    }

    function render(){
        var  texture = new THREE.TextureLoader().load('images/caodi.jpg');
//        texture.wrapS = THREE.RepeatWrapping;
//        texture.wrapT = THREE.RepeatWrapping;


        scene.traverse( function ( child ) {
            if ( child instanceof THREE.Group ) {
//                console.log("child.name  " +child.name);
                /*//给name为A开头的模型贴图
                if(child.name.indexOf("ma_obj")==0){
//                    console.log("mamamam");
                    child.traverse( function ( child ) {
                        child.material = new THREE.MeshPhongMaterial({
                            color: 0xff0000 ,
                            map: texture,
                        });//(红色)
                        child.material.needsUpdate = true;
                    });
                    child.material.needsUpdate = true;
                    /!*for(var i=0;i < child.children.length;i++){
                        child.children[i].material = new THREE.MeshPhongMaterial({
                            color: 0xff0000 ,
                            map: texture,
                        });
                    }*!/
                }*/

            }
        } );

        /*meshObj.children[4].material = new THREE.MeshPhongMaterial({
            color: 'red' ,
                    map: texture,
        });
        meshObj.children[7].material = new THREE.MeshPhongMaterial({
            color: 'red' ,
                    map: texture,
        });*/

        renderer.autoClear = false;
        //sphere.rotation.y=step+=0.01;
        var delta = clock.getDelta();
        controls.update(delta);

//        renderer.render(scene, camera);//调用WebGLRenderer的render函数刷新场景
        requestAnimationFrame(render);
        composer.render(delta);


    }
</script>
</body>
</html>