<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            /*background-color: #fff;*/
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display:block;
        }
        #info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }
    </style>
</head>
<body>
<!--<script type="text/javascript" src="../learning-threejs-master/libs/three.js"></script>
<script type="text/javascript" src="../learning-threejs-master/libs/OBJLoader.js"></script>
<script type="text/javascript" src="../learning-threejs-master/libs/MTLLoader.js"></script>
<script type="text/javascript" src="../learning-threejs-master/libs/OBJMTLLoader.js"></script>-->


<script src="../three.js-master/build/three.js"></script>
<script src="../three.js-master/examples/js/loaders/OBJLoader.js"></script>
<script src="../three.js-master/examples/js/loaders/MTLLoader.js"></script>

<script src="../three.js-master/examples/js/controls/TrackballControls.js"></script>
<script src="../three.js-master/examples/js/controls/OrbitControls.js"></script>


<script src="../three.js-master/examples/js/shaders/CopyShader.js"></script>
<script src="../three.js-master/examples/js/shaders/FXAAShader.js"></script>
<script src="../three.js-master/examples/js/postprocessing/EffectComposer.js"></script>
<script src="../three.js-master/examples/js/postprocessing/RenderPass.js"></script>
<script src="../three.js-master/examples/js/postprocessing/ShaderPass.js"></script>
<script src="../three.js-master/examples/js/postprocessing/OutlinePass.js"></script>
<script src="../three.js-master/examples/js/postprocessing/MaskPass.js"></script>
<div id="glFullscreen">
    <!--<canvas id="mainCanvas" width="1920" height="948"></canvas>-->
    <!--<canvas id="mainCanvas" width="1800" height="900"></canvas>-->
    <canvas id="example"></canvas>
</div>

<script type="text/javascript">
    var container;
    var camera, scene, renderer;

    var  meshObj = null;

    //测试
    var composer, effectFXAA, outlinePass;
    var obj3d = new THREE.Object3D();

    var group = new THREE.Group();

    var raycaster = new THREE.Raycaster();

    var mouse = new THREE.Vector2();
    var selectedObjects = [];

    var OBJFlag = true;

    init();

    function init() {
        renderer = new THREE.WebGLRenderer({//渲染器
            canvas: document.getElementById('example')//画布
            , alpha: true//设置场景透明
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        scene = new THREE.Scene();//创建场景

        //            网格宽度、等分数、中心线颜色，网格线颜色
        var helper = new THREE.GridHelper(1200, 60, 0xFF4444, 0x404040);
        scene.add(helper);

        camera = new THREE.PerspectiveCamera( 45, 1, 0.1, 10000 );//透视摄影机
        camera.position.set(1300.0, 600.0, 1200.0);//相机位置

//            camera.position.set(-0.0, 0.0, 0.0);//相机位置
//            camera.lookAt(new THREE.Vector3(0, 2, 0));//lookAt()设置相机所看的位置
//            camera.lookAt(new THREE.Vector3(0, 0, 0));//lookAt()设置相机所看的位置
//            camera.lookAt(new THREE.Vector3(0, 0, 0));//lookAt()设置相机所看的位置
        camera.lookAt(scene.position);//lookAt()设置相机所看的位置

        scene.add(camera);//把相机添加到场景中

        //环境光
//        var ambientLight = new THREE.AmbientLight( 0x404040 );
        var ambientLight = new THREE.AmbientLight( 'white' );
        //方向光
        var directionalLight1 = new THREE.DirectionalLight( 0xC0C090 );
        var directionalLight2 = new THREE.DirectionalLight( 0xC0C090 );
//            var ambientLight = new THREE.AmbientLight( 'white' );
//            var directionalLight1 = new THREE.DirectionalLight( 'white' );
//            var directionalLight2 = new THREE.DirectionalLight( 'white' );
        directionalLight1.position.set( -100, -50, 100 );
        directionalLight2.position.set( 100, 50, -100 );
        scene.add(directionalLight1);
        scene.add(directionalLight2);
        scene.add(ambientLight);


////监听鼠标、键盘事件，旋转图形
        var controls = new THREE.OrbitControls(camera);


        var material = new THREE.MeshPhongMaterial({
//            color: 'green',
            wireframe:false,
            map: new THREE.TextureLoader().load('images/xian1.jpg'),
        })
        box = new THREE.Mesh(new THREE.BoxBufferGeometry(100,100,100,10,10,10),material);
//        scene.add(box);

        /***
         * 加载obj
         * @type {THREE.OBJLoader}
         */
        var  texture = new THREE.TextureLoader().load('images/xian1.jpg');
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;

        var mtlLoader = new THREE.MTLLoader();
        mtlLoader.setPath('obj/skjc/');
        mtlLoader.load('shukongjichuang.mtl', function (materials) {
            materials.preload();//预加载

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('obj/skjc/');
//                objLoader.setPath('obj/');
//                objLoader.load('OBJ-TEST.obj', function(object) {
//                objLoader.load('car.obj', function(object) {
            objLoader.load("shukongjichuang.obj", function (object) {
                        object.rotation.y = 0;
                        object.position.x = 0;
                        object.position.y = 100;
                        object.position.z = 0;
//            object.scale.set(0.1, 0.1, 0.1);//缩放

                        object.name = 'shukongjichuang';
//                    object.scale.multiplyScalar(1);
                        meshObj = object;
                        obj3d.add(object);
                        group.add(object);
                        //放入场景
                        scene.add(object);

                    },
                    onProgress, onError);
        });

        mtlLoader.load('shukongjichuang2.mtl', function (materials) {
            materials.preload();//预加载

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('obj/skjc/');
            objLoader.load("shukongjichuang2.obj", function (object) {
                        object.rotation.y = 0;
                        object.position.x = 300;
                        object.position.y = 100;
                        object.position.z = 200;
//            object.scale.set(0.1, 0.1, 0.1);//缩放

                        object.name = 'shukongjichuang2';
//                    object.scale.multiplyScalar(1);
                        /*object.traverse( function ( child ) {
                            if ( child instanceof THREE.Mesh ) {
                                //给name为A开头的模型贴图
//                            if(child.name.indexOf("A")==0){
//                                child.material.map = texture;
                                //每个储位单独赋予一个基础材质
                            child.material = new THREE.MeshPhongMaterial({color:  0xff0000});//(红色)
//                            child.material.map = texture;
//                            }
                            }
                        } );*/
                        object.children[0].material = new THREE.MeshLambertMaterial({
//                            color:  0xff0000,
                            side: THREE.FrontSide,
//                            opacity:0.6,
//                            transparent:true,
//                            ambient:'red',//环境色
                            emissive:'green',
//                            shiniess:5,
//                            blending:THREE.NormalBlending,
                            needsUpdate:true,
                        });//(红色)

                        meshObj = object;
                        //放入场景
                        scene.add(object);

                    },
                    onProgress, onError);
        });

        mtlLoader.load('kaijuanji.mtl', function (materials) {
            materials.preload();//预加载

            var objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('obj/skjc/');
            objLoader.load("kaijuanji.obj", function (object) {
                        object.rotation.y = 0;
                        object.position.x = -300;
                        object.position.y = 110;
                        object.position.z = 200;
//            object.scale.set(0.1, 0.1, 0.1);//缩放
                        object.name = 'kaijuanji';
                        meshObj = object;
                        //放入场景
                        scene.add(object);

                    },
                    onProgress, onError);
        });
        //TODO  后期处理测试中
        composer = new THREE.EffectComposer( renderer );

        var renderPass = new THREE.RenderPass( scene, camera );
        composer.addPass( renderPass );

        outlinePass = new THREE.OutlinePass( new THREE.Vector2( window.innerWidth, window.innerHeight ), scene, camera );
        composer.addPass( outlinePass );

        /*var onLoad = function ( texture ) {

            outlinePass.patternTexture = texture;
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;

        };*/

        var loader = new THREE.TextureLoader();

//        loader.load( 'images/caodi.jpg', onLoad );
        loader.load( 'images/caodi.jpg', function(texture){
            outlinePass.patternTexture = texture;
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;

        } );

        effectFXAA = new THREE.ShaderPass( THREE.FXAAShader );//抗锯齿效果
        effectFXAA = new THREE.ShaderPass( THREE.ColorifyShader );//蒙上一层颜色
//        effectFXAA.uniforms[ 'resolution' ].value.set( 1 / window.innerWidth, 1 / window.innerHeight );
        effectFXAA.renderToScreen = true;
        composer.addPass( effectFXAA );
        outlinePass.selectedObjects = obj3d;
//        window.addEventListener( 'resize', onWindowResize, false );

//        window.addEventListener( 'mousemove', onTouchMove );
//        window.addEventListener( 'touchmove', onTouchMove );

        function onTouchMove( event ) {

            var x, y;

            if ( event.changedTouches ) {

                x = event.changedTouches[ 0 ].pageX;
                y = event.changedTouches[ 0 ].pageY;

            } else {

                x = event.clientX;
                y = event.clientY;

            }

            mouse.x = ( x / window.innerWidth ) * 2 - 1;
            mouse.y = - ( y / window.innerHeight ) * 2 + 1;

            checkIntersection();

        }

        function addSelectedObject( object ) {

            selectedObjects = [];
            selectedObjects.push( object );

        }

        function checkIntersection() {

            raycaster.setFromCamera( mouse, camera );

            var intersects = raycaster.intersectObjects( [ scene ], true );

            if ( intersects.length > 0 ) {

                var selectedObject = intersects[ 0 ].object;
                addSelectedObject( selectedObject );
                outlinePass.selectedObjects = selectedObjects;

            } else {

                // outlinePass.selectedObjects = [];

            }

        }
        box.material = new THREE.MeshPhongMaterial({
//            color: 0xff0000 ,
            map: new THREE.TextureLoader().load('images/caodi.jpg'),
        });//(红色)


        /*obj3d.material = new THREE.MeshPhongMaterial({
            color: 'red' ,
            map: new THREE.TextureLoader().load('images/caodi.jpg'),
        });//(红色)*/



        animate();

    }
    var onProgress = function(xhr) {
        if (xhr.lengthComputable) {
            var percentComplete = xhr.loaded / xhr.total * 100;
            var percent = document.getElementById("percent");
//                    percent.innerText = Math.round(percentComplete, 2) + '% 已经加载';
        }

       console.log("onProgress 方法执行完毕");
    };
    var onError = function(xhr) {};
    function animate() {


        requestAnimationFrame( animate );

        render();

        /*if(OBJFlag){
            /!*meshObj.traverse( function ( child ) {
                if ( child instanceof THREE.Mesh ) {
                    //给name为A开头的模型贴图
//                            if(child.name.indexOf("A")==0){
//                                child.material.map = texture;
                    //每个储位单独赋予一个基础材质
                    child.material = new THREE.MeshPhongMaterial({
//                    color: 0xff0000 ,
                        map: new THREE.TextureLoader().load('images/envmap1.jpg'),
                    });//(红色)
//                            child.material.map = texture;
//                            }
                    OBJFlag = false;
                }
            } );*!/
            meshObj.children[0].material = new THREE.MeshPhongMaterial({
                    color: 0xff0000 ,
//                map: new THREE.TextureLoader().load('images/envmap1.jpg'),
            });

        }*/

    }

    function render(){
        var  texture = new THREE.TextureLoader().load('images/caodi.jpg');
//        texture.wrapS = THREE.RepeatWrapping;
//        texture.wrapT = THREE.RepeatWrapping;


        scene.traverse( function ( child ) {
            if ( child instanceof THREE.Group ) {
//                console.log("child.name  " +child.name);
                /*//给name为A开头的模型贴图
                if(child.name.indexOf("ma_obj")==0){
//                    console.log("mamamam");
                    child.traverse( function ( child ) {
                        child.material = new THREE.MeshPhongMaterial({
                            color: 0xff0000 ,
                            map: texture,
                        });//(红色)
                        child.material.needsUpdate = true;
                    });
                    child.material.needsUpdate = true;
                    /!*for(var i=0;i < child.children.length;i++){
                        child.children[i].material = new THREE.MeshPhongMaterial({
                            color: 0xff0000 ,
                            map: texture,
                        });
                    }*!/
                }*/

            }
        } );

        /*meshObj.children[4].material = new THREE.MeshPhongMaterial({
            color: 'red' ,
                    map: texture,
        });
        meshObj.children[7].material = new THREE.MeshPhongMaterial({
            color: 'red' ,
                    map: texture,
        });*/

        renderer.render(scene, camera);//调用WebGLRenderer的render函数刷新场景


    }
</script>
</body>
</html>